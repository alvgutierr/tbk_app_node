<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pago en la nube</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="./css/styles.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet" />
</head>
<body>
  <div class="container-fluid d-flex flex-column justify-content-center align-items-center main-container">
    <nav class="navbar custom-navbar fixed-top">
      <div class="container-fluid justify-content-center">
        <span class="navbar-brand mb-0 titulo-navbar">Pago en la nube</span>
      </div>
    </nav>

    <div class="formulario">
      <img src="./images/Logotransbank2.svg" alt="Logo Transbank" class="logo" />
      <form class="w-100 d-flex flex-column align-items-center" novalidate>
        <div class="mb-4 d-flex flex-column align-items-center w-100">
          <label class="form-label campo-label">Ingrese monto</label>
          <input type="number" class="form-control campo-input" placeholder="$" min="1" />
        </div>

        <div class="mb-4 d-flex flex-column align-items-center w-100 position-relative">
          <label class="form-label campo-label">Selecciona terminal</label>
          <div class="dropdown w-100 d-flex justify-content-center">
            <button id="dropdownTerminal" class="btn btn-light dropdown-toggle campo-input" type="button" data-bs-toggle="dropdown" aria-expanded="false">
              <img src="./images/icono1.png" alt="A50" class="icono-terminal"> Seleccione Terminal
            </button>
            <ul class="dropdown-menu w-auto">
              <li><a class="dropdown-item d-flex align-items-center" href="#"><img src="./images/icono1.png" alt="A50" class="icono-terminal me-2"> A50 - 50122323440</a></li>
              <li><a class="dropdown-item d-flex align-items-center" href="#"><img src="./images/icono1.png" alt="B51" class="icono-terminal me-2"> B51 - 51122323441</a></li>
              <li><a class="dropdown-item d-flex align-items-center" href="#"><img src="./images/icono1.png" alt="C52" class="icono-terminal me-2"> C52 - 52122323442</a></li>
              <li><a class="dropdown-item d-flex align-items-center" href="#"><img src="./images/icono1.png" alt="C53" class="icono-terminal me-2"> C53 - 53122323443</a></li>
            </ul>
          </div>
        </div>

        <div class="d-flex justify-content-center gap-3 mt-3">
          <button type="submit" class="btn btn-pagar">Pagar</button>
          <button type="button" class="btn btn-imprimir">Imprimir</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Enviando -->
  <div class="modal fade" id="modalEnviando" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content modal-envio">
        <div class="modal-body text-center">
          <img src="./images/loading.gif" alt="Enviando..." class="gif-enviando mb-3">
          <p class="texto-enviando">Enviando...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Comprobante -->
  <div class="modal fade" id="modalComprobante" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content modal-comprobante p-4">
        <h5 class="titulo-modal-comprobante text-center mb-4">Comprobante de venta</h5>
        <div class="form-group">
          <textarea id="textoComprobante" class="form-control textarea-comprobante" rows="15">
TRANSBANK
VENTA - COPIA COMERCIO

TARJETA DE CREDITO
PRUEBA 18:00

RZ COMERCIO DE PRUEBA
LAS HUALTATAS 2547
TEXAS
RUT: 77.440.617-4
44444444444-A1708520-I24.3A0

VALIDO COMO BOLETA
24/07/2024 17:54:17 A0000000031010

VISA CREDITO                            ****8319 C-VI
MONTO VENTA :                           $405
IVA :                                   $77
SUBTOTAL :                              $482
PROPINA :                               $30
TOTAL :                                 $512
18 CUOTAS CON INTERES
MONTO CUOTA :                           $150
MONEDA :                                PESO

BOLETA: 8989                   EMPLEADO: 3333
OPERACION: 000237             AUTORIZACION: 006214
          </textarea>
        </div>
        <div class="d-flex justify-content-center gap-3 mt-4">
          <button class="btn btn-pagar" id="btnEnviarImpresion">Imprimir</button>
          <button class="btn btn-imprimir" data-bs-dismiss="modal">Cancelar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Global constants -->
  <script>
    const COMMERCE_CODE = "597029414340";
    const URL_NOTIFY = "https://api.pago.com/597029414300";
  </script>

  <!-- Bootstrap -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Dropdown Terminal Selection -->
  <script>
    document.querySelectorAll('.dropdown-menu .dropdown-item').forEach(item => {
      item.addEventListener('click', function (e) {
        e.preventDefault();
        const selectedContent = this.innerHTML;
        document.getElementById('dropdownTerminal').innerHTML = selectedContent;
      });
    });
  </script>

  <!-- Pago -->
  <script>
    document.querySelector('.btn-pagar').addEventListener('click', async function (e) {
      e.preventDefault();

      const montoInput = document.querySelector('input[type=number]');
      const terminalText = document.getElementById("dropdownTerminal").innerText.trim();
      const terminalId = terminalText.split("-")[1]?.trim() || "";

      if (!montoInput.value || parseInt(montoInput.value) <= 0) {
        alert("❌ Debes ingresar un monto válido.");        
        montoInput.focus();
        montoInput.select();
        return;
      }

      if (!terminalId || terminalId.length < 5) {
        alert("❌ Debes seleccionar un terminal válido.");       
        const terminalBtn = document.getElementById('dropdownTerminal');
        terminalBtn.classList.add("input-alert");
        setTimeout(() => terminalBtn.classList.remove("input-alert"), 2000);
        terminalBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
        return;
      }

      const payload = {
        commerceCode: COMMERCE_CODE,
        terminalId,
        transactionHostId: generarTransactionId(),
        urlNotify: URL_NOTIFY,
        totalPayment: parseInt(montoInput.value)
      };

      console.log("[Payload enviado]", payload);

      try {
        const modal = new bootstrap.Modal(document.getElementById('modalEnviando'));
        modal.show();

        const res = await fetch("api/pago", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-Client-Id": "1"
          },
          body: JSON.stringify(payload)
        });

        //const data = await res.json();
        //-----------        
         if (res.status === 200) {
          document.querySelector(".texto-enviando").innerText = "✅ Solicitud enviada correctamente.";
          // Crear y agregar el botón "Aceptar"
            const btnAceptar = document.createElement("button");
            btnAceptar.className = "btn btn-primary mt-3";
            btnAceptar.innerText = "Aceptar";
            btnAceptar.onclick = () => location.reload();

            const modalBody = document.querySelector("#modalEnviando .modal-body");
            if (!modalBody.querySelector(".btn-secondary")) {
              modalBody.appendChild(btnAceptar);
            }
          //modal.hide();
        } else {          
          const data = await res.json();
          
          if (res.status === 422) {            
            const detalleError = data?.errors?.[0]?.detail || "❌ Error 422 desconocido.";
            document.querySelector(".texto-enviando").innerText = `⚠️ ${detalleError}`;
            // Crear y agregar el botón "Aceptar"
            const btnAceptar = document.createElement("button");
            btnAceptar.className = "btn btn-primary mt-3";
            btnAceptar.innerText = "Aceptar";
            btnAceptar.onclick = () => location.reload();

            const modalBody = document.querySelector("#modalEnviando .modal-body");
            if (!modalBody.querySelector(".btn-secondary")) {
              modalBody.appendChild(btnAceptar);
            }

            //modal.hide();
          } else{
              alert("Respuesta:\n" + JSON.stringify(data, null, 2));
          }
        }
        //-----------


      } catch (err) {
        alert("Error al procesar el pago:\n" + err.message);
      }
    });

    function generarTransactionId() {
      const guid = crypto.randomUUID();
      const rand = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
      return `TX-${guid}-${rand}`;
    }
  </script>

  <script>
  // Instancia global del modal para poder ocultarlo después
  const modalComprobante = new bootstrap.Modal(document.getElementById('modalComprobante'));

  document.querySelector('.btn-imprimir').addEventListener('click', function (e) {
    e.preventDefault();
    modalComprobante.show();
  });
</script>

  <!-- Enviar a impresión -->
  <script>
    document.getElementById("btnEnviarImpresion").addEventListener("click", async function (e) {
      e.preventDefault();

      const message = document.getElementById("textoComprobante").value.trim();
      const terminalText = document.getElementById("dropdownTerminal").innerText.trim();
      const terminalId = terminalText.split("-")[1]?.trim() || "";

      if (!message) {
        alert("❌ El texto del comprobante está vacío.");
        return;
      }

      if (!terminalId || terminalId.length < 5) {
        alert("❌ Debes seleccionar un terminal válido.");                
        modalComprobante.hide();
        const terminalBtn = document.getElementById('dropdownTerminal');
        terminalBtn.classList.add("input-alert");
        setTimeout(() => terminalBtn.classList.remove("input-alert"), 2000);
        terminalBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
        return;
      }

      const payload = {
        commerceCode: COMMERCE_CODE,
        terminalId,
        transactionHostId: generarTransactionId(),
        type: "text",
        message
      };

      console.log("[Payload impresión]", payload);

      try {
        const res = await fetch("api/impresion", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-Client-Id": "1"
          },
          body: JSON.stringify(payload)
        });

        if (res.status === 204) {
          alert("✅ Solicitud enviada correctamente.");
          modalComprobante.hide();
        } else {          
          const data = await res.json();
          //alert("Respuesta:\n" + JSON.stringify(data, null, 2));
          if (res.status === 200) {
            alert("✅ Solicitud enviada correctamente.");            
            modalComprobante.hide();
          } 
        }
      } catch (err) {
        alert("❌ Error al enviar impresión: " + err.message);
      }
    });
  </script>
</body>
</html>
